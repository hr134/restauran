{% extends 'admin/admin_base.html' %}

{% block title %}Employee Requests - Admin{% endblock %}

{% block admin_title %}Employee Approval Workflow{% endblock %}

{% block content %}
<div class="glass-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0 text-white">Pending Requests</h5>
        <span class="badge badge-admin-info">{{ requests|length }} Requests</span>
    </div>

    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Details</th>
                    <th>Salary</th>
                    <th>Requested By</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                <tr id="req-row-{{ req.id }}">
                    <td>#{{ req.id }}</td>
                    <td>
                        <div class="fw-bold text-white">{{ req.user.username }}</div>
                        <div class="small text-muted">{{ req.user.full_name or 'No Name' }}</div>
                    </td>
                    <td>
                        <span
                            class="badge {% if req.request_type == 'promotion' %}bg-info{% else %}bg-secondary{% endif %}">
                            {{ req.request_type|replace('_', ' ')|capitalize }}
                        </span>
                    </td>
                    <td>
                        {% if req.request_type == 'promotion' %}
                        <div class="small text-white">Pos: {{ req.position }}</div>
                        <div class="small text-muted">Dept: {{ req.department }}</div>
                        {% else %}
                        <div class="small text-white">New Status:
                            <span
                                class="badge {% if req.requested_status == 'active' %}bg-success{% else %}bg-warning{% endif %}">
                                {{ req.requested_status|capitalize }}
                            </span>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if req.salary %}à§³{{ "%.2f"|format(req.salary) }}{% else %}-{% endif %}
                    </td>
                    <td>
                        <div class="small text-white">{{ req.requested_by.username }}</div>
                    </td>
                    <td>
                        <span class="small text-muted">{{ req.created_at.strftime('%Y-%m-%d') }}</span>
                    </td>
                    <td>
                        <span
                            class="badge {% if req.status == 'pending' %}bg-warning text-dark{% elif req.status == 'approved' %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                            {{ req.status|capitalize }}
                        </span>
                    </td>
                    <td>
                        {% if req.status == 'pending' %}
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="openActionModal({{ req.id }}, 'approve')">
                                <i class="bi bi-check-circle"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="openActionModal({{ req.id }}, 'reject')">
                                <i class="bi bi-x-circle"></i> Reject
                            </button>
                        </div>
                        {% else %}
                        <button class="btn btn-sm btn-outline-light"
                            onclick="viewNotes({{ req.id }}, {{ req.admin_notes|tojson }})">
                            <i class="bi bi-info-circle"></i> Notes
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-4 text-muted">No requests found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Action Modal (Approve/Reject) -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark-pro border-secondary text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="actionModalTitle">Process Request</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="actionReqId">
                <input type="hidden" id="actionType">
                <div class="mb-3">
                    <label for="adminNotes" class="form-label text-muted small">Admin Notes / Reason</label>
                    <textarea id="adminNotes" class="form-control admin-input" rows="3"
                        placeholder="Enter notes here..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn" id="actionSubmitBtn" onclick="submitAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- View Notes Modal -->
<div class="modal fade" id="viewNotesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark-pro border-secondary text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Request Notes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="notesDisplay" class="p-3 bg-darker rounded border border-secondary small"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openActionModal(id, type) {
        document.getElementById('actionReqId').value = id;
        document.getElementById('actionType').value = type;

        const title = type === 'approve' ? 'Approve Employee Request' : 'Reject Employee Request';
        const btnClass = type === 'approve' ? 'btn-success' : 'btn-danger';
        const btnText = type === 'approve' ? 'Approve' : 'Reject';

        document.getElementById('actionModalTitle').textContent = title;
        const submitBtn = document.getElementById('actionSubmitBtn');
        submitBtn.className = `btn ${btnClass}`;
        submitBtn.textContent = btnText;

        document.getElementById('adminNotes').value = '';

        const modal = new bootstrap.Modal(document.getElementById('actionModal'));
        modal.show();
    }

    function submitAction() {
        const id = document.getElementById('actionReqId').value;
        const type = document.getElementById('actionType').value;
        const notes = document.getElementById('adminNotes').value;

        const formData = new FormData();
        formData.append('admin_notes', notes);
        formData.append('csrf_token', '{{ csrf_token() }}');

        const url = `/admin/employee-request/${id}/${type}`;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, type === 'approve' ? 'success' : 'warning');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(data.message, 'danger');
                }
            })
            .catch(err => {
                console.error('Error:', err);
                showNotification('An error occurred while processing the request.', 'danger');
            });

        const modal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
        modal.hide();
    }

    function viewNotes(id, notes) {
        document.getElementById('notesDisplay').textContent = notes || 'No notes available.';
        const modal = new bootstrap.Modal(document.getElementById('viewNotesModal'));
        modal.show();
    }
</script>
{% endblock %}