{% extends 'admin/admin_base.html' %}

{% block title %}Dashboard - Admin{% endblock %}

{% block admin_title %}Dashboard Overview{% endblock %}

{% block content %}

<!-- QUICK STATS -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="glass-card text-center">
      <div class="text-muted small mb-1">Total Sales</div>
      <h3 class="mb-0 text-white">${{ '%.2f'|format(total_sales) }}</h3>
    </div>
  </div>
  <div class="col-md-3">
    <div class="glass-card text-center">
      <div class="text-muted small mb-1">Recent Orders</div>
      <h3 class="mb-0 text-white">{{ orders|length }}</h3>
    </div>
  </div>
  <div class="col-md-3">
    <div class="glass-card text-center">
      <div class="text-muted small mb-1">Total Reservations</div>
      <h3 class="mb-0 text-white">{{ reservations|length }}</h3>
    </div>
  </div>
  <div class="col-md-3">
    <div class="glass-card text-center">
      <div class="text-muted small mb-1">Menu Items</div>
      <h3 class="mb-0 text-white">{{ items|length }}</h3>
    </div>
  </div>
</div>

<!-- SEARCH AND ACTIONS -->
<div class="glass-card mb-4">
  <div class="row align-items-center">
    <div class="col-md-7">
      <div class="d-flex align-items-center justify-content-between bg-dark-pro border border-secondary rounded p-3">
        <div class="d-flex align-items-center border-end border-secondary pe-3 me-3">
          <i class="bi bi-clock-history fs-3 text-info me-3"></i>
          <div>
            <small class="text-muted d-block uppercase" style="font-size: 0.7rem;">Local Time</small>
            <span id="liveClock" class="fw-bold text-white fs-5" style="letter-spacing: 1px;">--:--:--</span>
            <script>
              (function () {
                function u() {
                  const c = document.getElementById('liveClock');
                  if (c) c.innerText = new Date().toLocaleTimeString([], { hour12: true });
                }
                setInterval(u, 1000);
                setTimeout(u, 1);
              })();
            </script>
          </div>
        </div>

        <div class="d-flex align-items-center border-end border-secondary pe-3 me-3">
          <i class="bi bi-fire fs-3 text-{{ kitchen_status_color }} me-3"></i>
          <div>
            <small class="text-muted d-block uppercase" style="font-size: 0.7rem;">Kitchen Load</small>
            <span
              class="badge bg-{{ kitchen_status_color }} bg-opacity-10 text-{{ kitchen_status_color }} border border-{{ kitchen_status_color }} rounded-pill">
              {{ kitchen_status }} ({{ pending_orders_count }})
            </span>
          </div>
        </div>

        <div class="d-flex align-items-center" style="cursor: pointer;"
          onclick="new bootstrap.Modal(document.getElementById('activeStaffModal')).show()">
          <i class="bi bi-person-workspace fs-3 text-success me-3"></i>
          <div>
            <small class="text-muted d-block uppercase" style="font-size: 0.7rem;">Active Staff</small>
            <h5 class="mb-0 text-white">{{ active_staff_count }}</h5>
          </div>
          <i class="bi bi-chevron-right ms-3 text-muted" style="font-size: 0.8rem;"></i>
        </div>
      </div>
    </div>

    <div class="col-md-5 d-flex align-items-center justify-content-end">
      <a class="btn btn-outline-light me-2" href="{{ url_for('admin.index') }}"><i class="bi bi-arrow-clockwise"></i>
        Refresh</a>
      <a class="btn btn-outline-info me-2" href="{{ url_for('admin.users') }}"><i class="bi bi-people"></i> Users</a>
      <a class="btn btn-primary" href="{{ url_for('admin.add_menu') }}"><i class="bi bi-plus-lg"></i> Add Menu Item</a>
    </div>
  </div>
</div>

<!-- MENU ITEMS TABLE -->
<div class="glass-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="mb-0 text-white">Menu Management</h5>
  </div>
  <div class="table-responsive">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>
            <img
              src="{{ it.image and url_for('static', filename='uploads/' ~ it.image) or url_for('static', filename='img/placeholder.jpg') }}"
              class="admin-img-thumb" alt="{{ it.name }}">
          </td>
          <td><span class="fw-bold">{{ it.name }}</span></td>
          <td>{{ it.category }}</td>
          <td>${{ '%.2f'|format(it.price) }}</td>
          <td>
            {% if it.availability %}
            <span class="badge-admin badge-admin-success">Available</span>
            {% else %}
            <span class="badge-admin badge-admin-danger">Sold Out</span>
            {% endif %}
          </td>
          <td>
            <div class="btn-group">
              <a class="btn btn-sm btn-outline-info" href="{{ url_for('admin.edit_menu', item_id=it.id) }}"><i
                  class="bi bi-pencil"></i></a>
              <a class="btn btn-sm btn-outline-danger" href="{{ url_for('admin.delete_menu', item_id=it.id) }}"
                onclick="handlePremiumConfirm(event, 'Delete this item?', this, 'Confirm Deletion', 'bi-trash')"><i
                  class="bi bi-trash"></i></a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="row g-4 mt-4">
  <!-- RECENT ORDERS -->
  <div class="col-lg-6">
    <div class="glass-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0 text-white"><i class="bi bi-bag-check me-2 text-primary"></i>Recent Orders</h5>
        <a href="{{ url_for('admin.orders') }}" class="btn btn-sm btn-outline-light">View All</a>
      </div>
      <div class="list-group list-group-flush bg-transparent">
        {% for o in orders[:8] %}
        <div class="list-group-item bg-transparent border-secondary text-light px-0 py-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold text-white mb-1">
                <span class="text-primary me-2">{{ orders|length - loop.index0 }}.</span>
                <a href="javascript:void(0);" onclick="openOrderModal({{ o.id }})"
                  class="text-info text-decoration-none">
                  #{{ o.unique_order_number or o.id }}
                </a>
              </div>
              <div class="small text-muted">
                {% if o.user %}
                <a class="text-info text-decoration-none" href="javascript:void(0);"
                  onclick="openUserModal('{{ o.user.username }}')">@{{ o.user.username }}</a>
                {% else %}Anon{% endif %}
                &bull; ${{ '%.2f'|format(o.total) }}
              </div>
            </div>
            <span class="badge-admin 
              {% if o.status == 'Confirmed' %}badge-admin-success
              {% elif o.status == 'Paid' %}badge-admin-info
              {% else %}badge-admin-warning{% endif %}">
              {{ o.status }}
            </span>
          </div>
          <div class="small mt-2 text-muted"><i class="bi bi-clock me-1"></i>{{ o.created_at.strftime('%Y-%m-%d %H:%M')
            }}</div>
          <div class="mt-3">
            {% if o.status in ['Placed', 'Pending', 'Paid'] %}
            <a class="btn btn-sm btn-success py-0 px-2 small action-confirm"
              href="{{ url_for('admin.confirm_order', order_id=o.id, sl=orders|length - loop.index0) }}">Confirm</a>
            {% endif %}
            <a class="btn btn-sm btn-outline-danger py-0 px-2 small"
              href="{{ url_for('admin.delete_order', order_id=o.id, sl=orders|length - loop.index0) }}"
              onclick="handlePremiumConfirm(event, 'Delete order?', this, 'Confirm Delete', 'bi-exclamation-triangle')">Delete</a>
          </div>
        </div>
        {% else %}
        <div class="text-muted small">No recent orders.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- RESERVATIONS -->
  <div class="col-lg-6">
    <div class="glass-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0 text-white"><i class="bi bi-calendar-event me-2 text-primary"></i>Reservations</h5>
        <a href="{{ url_for('admin.reservations') }}" class="btn btn-sm btn-outline-light">View All</a>
      </div>
      <div class="list-group list-group-flush bg-transparent">
        {% for r in reservations[:8] %}
        <div class="list-group-item bg-transparent border-secondary text-light px-0 py-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold text-white mb-1">
                <span class="text-primary me-2">{{ reservations|length - loop.index0 }}.</span> Table {{ r.table_no }}
              </div>
              <div class="small text-muted">
                {% if r.user %}
                <a class="text-info text-decoration-none" href="javascript:void(0);"
                  onclick='openUserModal({{ r.user.username|tojson }})'>@{{ r.user.username }}</a>
                {% else %}Anon{% endif %}
                &bull; {{ r.guests }} Guests
              </div>
            </div>
            <span
              class="badge-admin {% if r.status == 'Canceled' %}badge-admin-danger{% elif r.status == 'Pending' %}badge-admin-warning{% else %}badge-admin-success{% endif %}">
              {{ r.status }}
            </span>
          </div>
          <div class="small mt-2 text-muted">
            <i class="bi bi-calendar3 me-1"></i>{{ r.date }} &bull; <i class="bi bi-alarm me-1"></i>{{ r.time }} &bull;
            <i class="bi bi-hourglass-split me-1"></i>{{ r.duration }}h
          </div>
          <div class="mt-3">
            {% if r.status == 'Pending' %}
            <a class="btn btn-sm btn-success py-0 px-2 small action-res"
              href="{{ url_for('admin.confirm_reservation', res_id=r.id) }}">Confirm</a>
            {% endif %}

            {% if r.status != 'Canceled' %}
            <a class="btn btn-sm btn-warning py-0 px-2 small action-res"
              href="{{ url_for('admin.cancel_reservation', res_id=r.id) }}">Cancel</a>
            {% endif %}

            <a class="btn btn-sm btn-outline-danger py-0 px-2 small"
              href="{{ url_for('admin.remove_reservation', res_id=r.id) }}"
              onclick="handlePremiumConfirm(event, 'Permanently remove this reservation?', this, 'Remove', 'bi-trash')">Remove</a>
          </div>
        </div>
        {% else %}
        <div class="text-muted small">No reservations.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<!-- (Using same logic, styling updated via admin.css/bootstrap-dark-utilities) -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark-pro border-secondary text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white">
          <i class="bi bi-person-gear me-2"></i>User Profile
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body border-secondary">
        <div class="text-center mb-4">
          <img id="userImage" src="" class="rounded-circle border border-secondary p-1" width="100" height="100"
            style="object-fit:cover;">
        </div>
        <div class="row g-3">
          <div class="col-12"><label class="text-muted small"
              style="color: rgb(204, 204, 204) !important;">Username</label><input type="text" id="userUsername"
              class="form-control admin-inpu" readonly></div>
          <div class="col-md-6">
            <label class="text-muted small" style="color: rgb(204, 204, 204) !important;;">
              Email
              <span id="userVerifiedBadge"></span>
            </label>
            <input type="email" id="userEmail" class="form-control admin-inpu">
          </div>
          <div class="col-md-6"><label class="text-muted small" style="color: rgb(204, 204, 204) !important;;">Full
              Name</label><input type="text" id="userFullName" class="form-control admin-inpu"></div>
          <div class="col-md-6"><label class="text-muted small"
              style="color: rgb(204, 204, 204) !important;;">Phone</label><input type="text" id="userPhone"
              class="form-control admin-inpu"></div>
          <div class="col-md-6"><label class="text-muted small"
              style="color: rgb(204, 204, 204) !important;;">City</label><input type="text" id="userCity"
              class="form-control admin-inpu"></div>
          <div class="col-12"><label class="text-muted small"
              style="color: rgb(204, 204, 204) !important;;">Street</label><input type="text" id="userStreet"
              class="form-control admin-inpu"></div>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-danger me-auto" onclick="deleteUser()">Delete User</button>
        <button type="button" class="btn btn-primary" onclick="saveUser()">Save Changes</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ORDER DETAIL MODAL -->
<!-- ACTIVE STAFF MODAL -->
<div class="modal fade" id="activeStaffModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border-secondary text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-people-fill me-2 text-success"></i>Active Staff</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div class="list-group list-group-flush">
          {% for staff in active_staff_list %}
          <div class="list-group-item bg-transparent border-secondary text-light d-flex align-items-center p-3">
            <img
              src="{{ staff.image and url_for('static', filename='uploads/' ~ staff.image) or url_for('static', filename='img/placeholder.jpg') }}"
              class="rounded-circle me-3 border border-secondary" width="40" height="40" style="object-fit:cover;">
            <div class="flex-grow-1">
              <div class="fw-bold">{{ staff.name }}</div>
              <div class="small text-info">@{{ staff.username }}</div>
              <div class="small text-muted">{{ staff.role }}</div>
            </div>
            <div class="text-end">
              <span
                class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill small">Active</span>
              <div class="small text-muted mt-1" style="font-size:0.7em;">Check-in: {{ staff.check_in }}</div>
            </div>
          </div>
          {% else %}
          <div class="p-4 text-center text-muted">No staff currently active.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="orderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark border-secondary text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white"><i class="bi bi-receipt me-2"></i>Order Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body border-secondary" id="orderModalBody">
        <div class="text-center p-4">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let currentUsername = '';

  function openUserModal(username) {
    if (!username) return;

    fetch(`/admin/user/${username}`)
      .then(res => { if (!res.ok) throw new Error('User not found'); return res.json(); })
      .then(data => {
        currentUsername = data.username;
        const userUsername = document.getElementById('userUsername');
        const userEmail = document.getElementById('userEmail');

        // Safety check if modal elements exist
        if (userUsername) userUsername.value = data.username;
        if (userEmail) userEmail.value = data.email;
        if (document.getElementById('userFullName')) document.getElementById('userFullName').value = data.full_name;
        if (document.getElementById('userPhone')) document.getElementById('userPhone').value = data.phone || '';
        if (document.getElementById('userStreet')) document.getElementById('userStreet').value = data.address_street || '';
        if (document.getElementById('userCity')) document.getElementById('userCity').value = data.address_city || '';
        if (document.getElementById('userImage')) document.getElementById('userImage').src = data.profile_image ? `/static/uploads/${data.profile_image}` : `/static/img/placeholder.jpg`;

        // Update verification badge
        const badge = document.getElementById('userVerifiedBadge');
        if (badge) {
          if (data.email_verified) {
            badge.innerHTML = '<span class="badge bg-success small ms-2" style="font-size: 0.6rem;">VERIFIED</span>';
          } else {
            badge.innerHTML = '<span class="badge bg-warning text-dark small ms-2" style="font-size: 0.6rem;">UNVERIFIED</span>';
          }
        }

        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('userModal'));
        modal.show();
      })
      .catch(err => alert(err.message));
  }

  function saveUser() {
    const payload = {
      email: document.getElementById('userEmail').value.trim(),
      full_name: document.getElementById('userFullName').value.trim(),
      phone: document.getElementById('userPhone').value.trim(),
      address_street: document.getElementById('userStreet').value.trim(),
      address_city: document.getElementById('userCity').value.trim()
    };

    fetch(`/admin/user/${currentUsername}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': '{{ csrf_token() }}'
      },
      body: JSON.stringify(payload)
    })
      .then(res => { if (!res.ok) throw new Error('Failed to update user'); return res.json(); })
      .then(data => {
        handleAjaxResponse(data, () => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
          if (modal) modal.hide();
        });
      })
      .catch(err => showNotification(err.message, 'danger'));
  }

  async function deleteUser() {
    if (!currentUsername) return;
    const confirmed = await showConfirm(`Are you sure you want to delete user "${currentUsername}"? This cannot be undone.`, "Delete User", "bi-person-x");
    if (!confirmed) return;

    fetch(`/admin/user/${currentUsername}/delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': '{{ csrf_token() }}'
      }
    })
      .then(res => { if (!res.ok) throw new Error('Failed to delete user'); return res.json(); })
      .then(data => {
        handleAjaxResponse(data, () => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
          if (modal) modal.hide();
        });
      })
      .catch(err => showNotification(err.message, 'danger'));
  }

  function openOrderModal(orderId) {
    const modalEl = document.getElementById('orderModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const body = document.getElementById('orderModalBody');
    body.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>';
    modal.show();

    fetch(`/admin/order/${orderId}`)
      .then(res => { if (!res.ok) throw new Error('Order not found'); return res.json(); })
      .then(data => {
        let itemsHtml = data.items.map(item => `
          <div class="d-flex justify-content-between border-bottom border-secondary py-2">
            <span class="text-stylish">${item.name} x ${item.qty}</span>
            <span class="text-white fw-bold">৳${(item.price * item.qty).toFixed(2)}</span>
          </div>
        `).join('');

        body.innerHTML = `
          <div class="row g-4">
            <div class="col-md-6">
              <label class="text-muted small d-block mb-1">Order Status</label>
              <span class="badge bg-${data.status === 'Confirmed' ? 'success' : 'primary'} mb-3">${data.status}</span>
              
              <label class="text-muted small d-block mb-1">Customer Info</label>
              <p class="text-white mb-0 fw-bold">${data.customer}</p>
              <p class="text-stylish small mb-2 text-info">@${data.username}</p>
              <p class="text-white mb-3"><i class="bi bi-telephone me-2"></i>${data.phone || 'N/A'}</p>
              
              <label class="text-muted small d-block mb-1">Delivery Address</label>
              <p class="text-white small mb-0">${data.address_street || ''}</p>
              <p class="text-white small mb-0">${data.address_city || ''} ${data.address_district || ''}</p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small d-block mb-3">Order Items</label>
              <div class="bg-black bg-opacity-25 rounded p-3 mb-3">
                ${itemsHtml}
                <div class="d-flex justify-content-between mt-3 pt-2 border-top border-white border-opacity-25">
                  <span class="text-white fw-bold">Total</span>
                  <span class="text-primary fw-bold fs-5">৳${data.total.toFixed(2)}</span>
                </div>
              </div>
              <small class="text-muted">Placed on ${data.created_at}</small>
            </div>
          </div>
        `;
      })
      .catch(err => {
        body.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      });
  }

  // --- AJAX Listeners for Dashboard Buttons ---
  function attachConfirmListeners() {
    document.querySelectorAll('.action-confirm').forEach(btn => {
      btn.replaceWith(btn.cloneNode(true));
    });
    document.querySelectorAll('.action-confirm').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const url = this.getAttribute('href');
        const container = this.closest('.list-group-item'); // Find parent item
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(res => res.json())
          .then(data => {
            handleAjaxResponse(data, () => {
              const badge = container.querySelector('.badge-admin');
              if (badge) {
                badge.className = 'badge-admin badge-admin-success';
                badge.textContent = 'Confirmed';
              }
              this.remove(); // Remove the button
            });
          })
          .catch(err => showNotification('Error confirming order', 'danger'));
      });
    });
  }

  function attachResListeners() {
    document.querySelectorAll('.action-res').forEach(btn => {
      btn.replaceWith(btn.cloneNode(true));
    });
    document.querySelectorAll('.action-res').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const url = this.getAttribute('href');
        const container = this.closest('.list-group-item');
        const isCancel = url.includes('/cancel/');

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(res => res.json())
          .then(data => {
            handleAjaxResponse(data, () => {
              const badge = container.querySelector('.badge-admin');
              if (isCancel) {
                if (badge) {
                  badge.className = 'badge-admin badge-admin-danger';
                  badge.textContent = 'Canceled';
                }
              } else {
                if (badge) {
                  badge.className = 'badge-admin badge-admin-success';
                  badge.textContent = 'Confirmed';
                }
              }
              // Clean up buttons in this container
              container.querySelectorAll('.action-res').forEach(b => b.remove());
            });
          })
          .catch(err => showNotification('Error processing reservation', 'danger'));
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    attachConfirmListeners();
    attachResListeners();
  });
  {% endblock %}