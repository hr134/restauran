<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>{% block title %}Finedineâ™¡ð“Œ‰â—¯ð“‡‹â‚ŠËš{% endblock %}</title>
  <meta name="description"
    content="Experience delicious food and fast delivery with Finedineâ™¡ð“Œ‰â—¯ð“‡‹â‚ŠËš. Order online or reserve a table today.">
  <meta name="keywords" content="restaurant, food delivery, reservation, dining, delicious meals">
  <meta property="og:title" content="Finedineâ™¡ð“Œ‰â—¯ð“‡‹â‚ŠËš - Delicious Food, Fast Delivery">
  <meta property="og:description"
    content="Order your favorite meals or book a table at Finedineâ™¡ð“Œ‰â—¯ð“‡‹â‚ŠËš. Fresh ingredients, great taste.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="{{ url_for('static', filename='img/pizza.jpg') }}">

  <link rel="shortcut icon" href="/static/img/mylogo.png">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts (Only used for Chatbot now) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- Main Custom CSS -->
  <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">

  <script>
    // Prevent white flash by applying theme instantly
    (function () {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    })();
  </script>

  {% block head %}{% endblock %}
</head>

<body class="d-flex flex-column min-vh-100">

  <!-- PAGE TRANSITION OVERLAY -->
  <div id="page-loader"></div>

  <!-- NOTIFICATION CONTAINER -->
  <div id="notification-container"></div>

  <!-- Premium Confirm Modal -->
  <div id="premium-confirm-overlay" class="premium-modal-overlay">
    <div class="premium-modal">
      <div id="confirm-icon" class="premium-modal-icon">
        <i class="bi bi-question-circle"></i>
      </div>
      <div id="confirm-title" class="premium-modal-title">Are you sure?</div>
      <div id="confirm-body" class="premium-modal-body">Do you really want to proceed with this action?</div>
      <div class="premium-modal-footer">
        <button id="confirm-cancel-btn" class="premium-modal-btn btn-cancel">Cancel</button>
        <button id="confirm-ok-btn" class="premium-modal-btn btn-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Global Verification Modal -->
  <div class="modal fade" id="verificationModal" tabindex="-1" aria-hidden="true" style="z-index: 10002;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white border-secondary shadow-lg">
        <div class="modal-header border-secondary">
          <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2 text-primary"></i>Verify Email</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="otp-input-area">
            <p class="small text-muted mb-3">We have sent a 4-digit code to <strong id="modal-email-display">your
                email</strong>. Please enter it below.</p>
            <div class="d-flex gap-2 justify-content-center mb-3">
              <input type="text" id="global-otp-code" class="form-control text-center fw-bold fs-4" placeholder="XXXX"
                maxlength="4"
                style="letter-spacing: 8px; max-width: 150px; background: #2a2a2a; border-color: #444; color: #fff;">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" id="global-verify-btn" onclick="globalVerifyCode()">Verify Now</button>
            </div>
          </div>
          <div id="otp-success-area" class="text-center py-4" style="display: none;">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Email Verified!</h5>
            <p class="text-muted small">Your account status has been updated.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CUSTOM CURSOR -->
  <div class="cursor-dot"></div>
  <div class="cursor-outline"></div>

  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">


    <div class="container">


      <a class="navbar-brand nav-brand" href="{{ url_for('main.index') }}">Finedineâ™¡ð“Œ‰â—¯ð“‡‹â‚ŠËš</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse">
        <span class="navbar-toggler-icon"></span>
      </button>



      <div class="collapse navbar-collapse" id="navCollapse">
        <ul class="navbar-nav ms-auto align-items-center">

          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.menu') }}">Menu</a></li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('cart.view_cart') }}">
              Cart (<span id="cart-count">{{ cart_count }}</span>)
            </a>
          </li>

          <!-- <li class="nav-item"><a class="nav-link" href="{{ url_for('chatbot.chat') }}">Chat</a></li> -->

          {% if session.get('username') %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('user.orders') }}">My Orders</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('reservations.my_reservations') }}">Reservations</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('user.profile') }}">Profile</a></li>

          {% if session.get('role') == 'admin' or session.get('is_admin') %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('admin.index') }}">Admin</a>
          </li>
          {% elif session.get('role') == 'manager' %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('employees.attendance') }}">Manager</a>
          </li>
          {% endif %}

          {% if session.get('role') in ['chef', 'admin'] or session.get('is_admin') %}
          <li class="nav-item"><a class="nav-link text-warning" href="{{ url_for('staff.chef') }}"><i
                class="bi bi-fire"></i> Chef</a></li>
          {% endif %}

          {% if session.get('role') in ['waiter', 'admin'] or session.get('is_admin') %}
          <li class="nav-item"><a class="nav-link text-info" href="{{ url_for('staff.waiter') }}"><i
                class="bi bi-person-badge"></i> Waiter</a></li>
          {% endif %}

          <li class="nav-item"><span class="nav-link disabled">Hi, {{ session.get('username') }}</span></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a></li>

          {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.login') }}">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.register') }}">Register</a></li>
          {% endif %}

          <li class="nav-item ms-2">
            <button id="theme-toggle" class="btn btn-sm btn-outline-secondary rounded-circle"
              style="width: 38px; height: 38px; padding: 0;">
              <i class="bi bi-moon-stars-fill"></i>
            </button>
          </li>

        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    <div id="flashed-messages" style="display: none;">
      {% for category, message in messages %}
      <div class="flash-msg" data-category="{{ category }}" data-message="{{ message }}"></div>
      {% endfor %}
    </div>
    {% if messages %}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.flash-msg').forEach(el => {
          const category = el.dataset.category;
          const message = el.dataset.message;
          const type = category === 'success' ? 'success' : (category === 'error' || category === 'danger' ? 'danger' : (category === 'warning' ? 'warning' : 'primary'));
          showNotification(message, type);
        });
      });
    </script>
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer mt-auto py-5">
    <div class="container text-center">
      <div class="secret-dish-wrap mb-4">
        <div class="track-container mx-auto" id="footer-tracker">
          <div class="track-ui">
            <div class="track-ui__text text-enabled">
              <div class="track-ui__text-title">
                <span class="msg-1">Secret Magic...</span>
                <span class="msg-2">Unleash your darkness</span>
              </div>
            </div>
            <div class="track-ui__text text-disabled">
              <div class="track-ui__text-title">Find your Recipe!</div>
            </div>

            <div class="track-ui__spell tracker">
              <input class="track-ui__spell-source" id="spell-switch" type="checkbox" />
              <div class="track-ui__spell-circle"></div>
            </div>

            <div class="track-ui__char" id="dish-char">
              <div class="track-ui__char-shadow"></div>
              <label class="track-ui__char-ball" for="spell-switch">
                <i class="bi bi-egg-fried text-white"
                  style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
              </label>
            </div>
          </div>
        </div>
      </div>
      <small class="text-muted d-block mb-2">Â© 2025 Finedine | Premium Dining Experience</small>
      <div class="footer-links">
        <a href="#" class="text-muted mx-2 small text-decoration-none">Terms</a>
        <a href="#" class="text-muted mx-2 small text-decoration-none">Privacy</a>
      </div>
    </div>
  </footer>



  <!-- FLOATING CHAT BUTTON -->
  <div id="chatbot-btn">ðŸ’¬</div>

  <!-- CHATBOT POPUP -->
  <div id="chatbot-window" class="light-mode-card">
    <div class="chat-header">
      AI Assistant
      <span id="chatbot-close" style="cursor: pointer;">âœ–</span>
    </div>

    <div id="chat-box" class="chat-box"></div>

    <div class="chat-input-sec">
      <input type="text" id="chat-input" placeholder="Ask something...">
      <button id="chat-send">Send</button>

      <!-- Mode selector removed -->
    </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Premium Notification System
    function showNotification(message, type = 'primary') {
      const container = document.getElementById('notification-container');
      const toast = document.createElement('div');
      toast.className = `custom-notification ${type}`;

      const icon = type === 'success' ? 'bi-check-circle-fill' :
        type === 'danger' ? 'bi-exclamation-triangle-fill' :
          type === 'warning' ? 'bi-exclamation-circle-fill' : 'bi-info-circle-fill';

      toast.innerHTML = `<i class="bi ${icon}"></i>`;
      const contentDiv = document.createElement('div');
      contentDiv.className = 'notif-content';
      contentDiv.textContent = message;
      toast.appendChild(contentDiv);

      container.appendChild(toast);

      // Auto-remove after 4 seconds
      setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 500);
      }, 4000);
    }

    // Override Alert
    window.alert = (msg) => showNotification(msg, 'primary');

    function addChatMessage(text, sender) {
      const box = document.getElementById("chat-box");
      const div = document.createElement("div");

      div.classList.add("message");
      div.classList.add(sender === "user" ? "user-message" : "bot-message");
      div.textContent = text;

      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function handlePremiumConfirm(event, message, target, title = "Confirm Action", icon = "bi-question-circle") {
      if (event) event.preventDefault();
      const targetUrl = target.href;
      const confirmed = await showConfirm(message, title, icon);
      if (confirmed) {
        window.location.href = targetUrl;
      }
    }

    async function showConfirm(message, title = "Confirm Action", iconClass = "bi-question-circle") {
      return new Promise((resolve) => {
        const overlay = document.getElementById('premium-confirm-overlay');
        const titleEl = document.getElementById('confirm-title');
        const bodyEl = document.getElementById('confirm-body');
        const iconEl = document.getElementById('confirm-icon');
        const okBtn = document.getElementById('confirm-ok-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');

        titleEl.textContent = title;
        bodyEl.textContent = message;
        iconEl.innerHTML = `<i class="bi ${iconClass}"></i>`;

        overlay.classList.add('show');

        const cleanup = (result) => {
          overlay.classList.remove('show');
          okBtn.onclick = null;
          cancelBtn.onclick = null;
          resolve(result);
        };

        okBtn.onclick = () => cleanup(true);
        cancelBtn.onclick = () => cleanup(false);
      });
    }

    // Override window.confirm
    window.originalConfirm = window.confirm;
    window.confirm = (msg) => {
      // Note: This won't work for simple synchronous scripts expectation 
      // but for our async action links we will use showConfirm directly.
      console.warn("Synchronous confirm() called. Use await showConfirm() for best results.");
      return window.originalConfirm(msg);
    };

    async function rateItem(itemId, score) {
      try {
        const response = await fetch('/api/rate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': '{{ csrf_token() }}'
          },
          body: JSON.stringify({ item_id: itemId, score: score })
        });
        const data = await response.json();

        if (response.status === 401) {
          showNotification(data.message, 'danger');
          return;
        }

        if (data.success) {
          showNotification(data.message, 'success');

          // Update stars in the UI
          const ratingContainer = document.querySelector(`.star-rating[data-item-id="${itemId}"]`);
          if (ratingContainer) {
            const stars = ratingContainer.querySelectorAll('i');
            stars.forEach((star, index) => {
              if (index < score) {
                star.classList.add('bi-star-fill', 'active');
                star.classList.remove('bi-star');
              } else {
                star.classList.add('bi-star');
                star.classList.remove('bi-star-fill', 'active');
              }
            });
            const text = ratingContainer.querySelector('.rating-text');
            if (text) text.textContent = `(${data.average})`;
          }
        } else {
          showNotification(data.message, 'danger');
        }
      } catch (error) {
        console.error('Error rating item:', error);
        showNotification('Something went wrong. Please try again.', 'danger');
      }
    }

    async function sendChatMessage() {
      const text = document.getElementById("chat-input").value.trim();
      if (!text) return;

      addChatMessage(text, "user");
      document.getElementById("chat-input").value = "";

      // Add loading mechanism
      const box = document.getElementById("chat-box");
      const loadingDiv = document.createElement("div");
      loadingDiv.classList.add("message", "bot-message");
      loadingDiv.textContent = "...";
      box.appendChild(loadingDiv);
      box.scrollTop = box.scrollHeight;

      try {
        const res = await fetch("/chatbot/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": "{{ csrf_token() }}"
          },
          body: JSON.stringify({ message: text })
        });

        const data = await res.json();
        box.removeChild(loadingDiv);

        // Render simple text response with basic formatting
        let answer = data.answer;
        if (answer) {
          const div = document.createElement("div");
          div.classList.add("message", "bot-message");
          div.style.whiteSpace = "pre-wrap";
          div.textContent = answer;
          box.appendChild(div);
        }

        // Handle Redirection
        if (data.redirect) {
          setTimeout(() => {
            window.location.href = data.redirect;
          }, 1500); // 1.5s delay so user can read the message
          return; // Stop further rendering if redirecting
        }

        // Render Options
        if (data.options && data.options.length > 0) {
          const optionsDiv = document.createElement("div");
          optionsDiv.classList.add("message", "bot-message");
          optionsDiv.style.background = "transparent";
          optionsDiv.style.padding = "0";
          optionsDiv.style.maxWidth = "100%"; // allow buttons to flow

          data.options.forEach(opt => {
            const btn = document.createElement("button");
            btn.textContent = opt;
            btn.style.margin = "4px 4px 0 0";
            btn.style.padding = "4px 8px";
            btn.style.fontSize = "0.85rem";
            btn.style.cursor = "pointer";
            btn.style.borderRadius = "12px";
            btn.style.border = "1px solid #ff5722";
            btn.style.background = "white";
            btn.style.color = "#ff5722";

            btn.onmouseover = () => { btn.style.background = "#ff5722"; btn.style.color = "white"; };
            btn.onmouseout = () => { btn.style.background = "white"; btn.style.color = "#ff5722"; };
            btn.onclick = () => {
              const redirects = {
                "View Menu": "{{ url_for('main.menu') }}",
                "View Cart": "{{ url_for('cart.view_cart') }}",
                "Checkout": "{{ url_for('orders.checkout') }}",
                "Book a Table": "{{ url_for('reservations.reserve') }}",
                "My Orders": "{{ url_for('user.orders') }}",
                "View My Reservations": "{{ url_for('reservations.my_reservations') }}"
              };

              if (redirects[opt]) {
                window.location.href = redirects[opt];
                return;
              }

              document.getElementById("chat-input").value = opt;
              sendChatMessage();
            };
            optionsDiv.appendChild(btn);
          });
          box.appendChild(optionsDiv);
        }

        box.scrollTop = box.scrollHeight;

      } catch (err) {
        box.removeChild(loadingDiv);
        addChatMessage("Sorry, ðŸ˜… Iâ€™m still learning and couldnâ€™t catch your request. You can ask me to: Show todayâ€™s menu, Add food to your cart(example: â€˜3 burgersâ€™), Guide you to reseerve a table. Please try again. Iâ€™ll take care of the rest ðŸ’¬", "bot");
        console.error(err);
      }
    }

    // Button click
    document.getElementById("chat-send").onclick = sendChatMessage;

    // Press Enter
    document.getElementById("chat-input").addEventListener("keypress", e => {
      if (e.key === "Enter") sendChatMessage();
    });

    // Open chat
    document.getElementById("chatbot-btn").onclick = () => {
      document.getElementById("chatbot-window").style.display = "flex";
    };

    // Close chat
    document.getElementById("chatbot-close").onclick = () => {
      document.getElementById("chatbot-window").style.display = "none";
    };

    // AJAX Add to Cart
    async function addToCart(itemId, btnElement) {
      try {
        const response = await fetch(`/cart/add/${itemId}`, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        const data = await response.json();
        if (data.success) {
          // Update Count
          const countEl = document.getElementById('cart-count');
          if (countEl) countEl.textContent = data.cart_count;

          // Add premium notification
          showNotification(data.message || "Added to cart!", 'success');

          // Button feedback (Message beside button)
          if (btnElement) {
            const feedback = document.createElement('span');
            feedback.textContent = `Added ${data.item_count}`;
            feedback.className = 'cart-feedback ms-2 small';

            // Insert after the button
            btnElement.parentNode.insertBefore(feedback, btnElement.nextSibling);

            // Trigger reflow to enable transition
            void feedback.offsetWidth;

            // Animate in
            feedback.classList.add('show');

            // Remove after 1 second (visible time)
            setTimeout(() => {
              // Animate out
              feedback.classList.remove('show');
              // Remove from DOM after transition matches CSS (0.3s)
              setTimeout(() => feedback.remove(), 300);
            }, 1000);
          }
        } else {
          showNotification(data.message || "Error adding item.", 'danger');
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    }

    // Magic Cursor & Secret Dish Logic
    (function () {
      const spellSwitch = document.getElementById('spell-switch');
      const footerTracker = document.getElementById('footer-tracker');
      const magicKey = 'magic_cursor_enabled';

      function updateMagicState(isEnabled) {
        if (isEnabled) {
          document.body.classList.add('magic-cursor-enabled');
        } else {
          document.body.classList.remove('magic-cursor-enabled');
        }
        if (spellSwitch) spellSwitch.checked = isEnabled;
        localStorage.setItem(magicKey, isEnabled);
      }

      // Init state
      const savedMagic = localStorage.getItem(magicKey) === 'true';
      updateMagicState(savedMagic);

      if (spellSwitch) {
        spellSwitch.addEventListener('change', (e) => {
          updateMagicState(e.target.checked);
        });
      }

      // Smooth Footer Tracking
      if (footerTracker) {
        document.addEventListener('mousemove', (e) => {
          const rect = footerTracker.getBoundingClientRect();
          // Check if mouse is hovering over the footer container
          if (e.clientX >= rect.left && e.clientX <= rect.right &&
            e.clientY >= rect.top && e.clientY <= rect.bottom) {
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            footerTracker.style.setProperty('--mouse-x', `${x}%`);
            footerTracker.style.setProperty('--mouse-y', `${y}%`);
          }
        });

        footerTracker.addEventListener('mouseleave', () => {
          footerTracker.style.setProperty('--mouse-x', '50%');
          footerTracker.style.setProperty('--mouse-y', '50%');
        });
      }
    })();
    // Global Email Verification Logic
    let currentVerifyEmail = '';
    async function initGlobalVerification(email) {
      if (!email || !email.includes('@')) {
        showNotification('Please enter a valid email address.', 'warning');
        return;
      }

      const btn = event?.target;
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
          const res = await fetch('/user/api/send-verification-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-TOKEN': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ email: email })
          });
          const data = await res.json();
          if (data.success) {
            currentVerifyEmail = email;
            document.getElementById('modal-email-display').textContent = email;
            document.getElementById('otp-input-area').style.display = 'block';
            document.getElementById('otp-success-area').style.display = 'none';
            const modal = new bootstrap.Modal(document.getElementById('verificationModal'));
            modal.show();
            showNotification(data.message, 'success');
          } else {
            showNotification(data.message, 'warning');
          }
        } catch (err) {
          console.error('Email verification error:', err);
          showNotification('System error: ' + err.message, 'danger');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }
    }

    async function globalVerifyCode() {
      const code = document.getElementById('global-otp-code').value;
      if (code.length !== 4) {
        showNotification('Enter 4-digit code.', 'warning');
        return;
      }

      const btn = document.getElementById('global-verify-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verifying...';

      try {
        const res = await fetch('/user/api/verify-email-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': '{{ csrf_token() }}'
          },
          body: JSON.stringify({ code: code, email: currentVerifyEmail })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('otp-input-area').style.display = 'none';
          document.getElementById('otp-success-area').style.display = 'block';

          // Update all verification badges in DOM
          document.querySelectorAll('.email-verify-badge').forEach(badge => {
            badge.className = 'email-verify-badge badge-verified';
            badge.innerHTML = '<i class="bi bi-patch-check-fill"></i> Verified';
            badge.onclick = null;
            badge.style.cursor = 'default';
          });

          showNotification(data.message, 'success');
          setTimeout(() => {
            const modalEl = document.getElementById('verificationModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }, 2000);
        } else {
          showNotification(data.message, 'warning');
        }
      } catch (err) {
        showNotification('Verification failed.', 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Verify Now';
      }
    }

    // Standardized handler for database + email notifications (Shared with Admin)
    function handleAjaxResponse(data, callback) {
      const actionMsg = data.message || 'Action completed successfully';
      showNotification(actionMsg, data.success ? 'success' : 'danger');

      if (data.success && data.email) {
        let emailMsg = '';
        let emailType = 'info';

        if (data.email_status === 'pending') {
          emailMsg = `Notification queued for ${data.email}`;
        } else if (data.email_status === true) {
          emailMsg = `Notification sent to ${data.email}`;
          emailType = 'success';
        } else if (data.email_status === false) {
          emailMsg = `Email couldn't be sent to ${data.email}`;
          emailType = 'warning';
        }

        if (emailMsg) {
          setTimeout(() => showNotification(emailMsg, emailType), 1500);
        }
      }

      if (data.success && typeof callback === 'function') {
        callback(data);
      }
    }

    // Lightweight polling mechanism
    function startPolling(url, interval, callback) {
      setInterval(() => {
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(res => res.json())
          .then(data => callback(data))
          .catch(err => console.error('Polling error:', err));
      }, interval);
    }

    // Generic AJAX Add to Cart Handler
    document.addEventListener('click', async function (e) {
      if (e.target.classList.contains('ajax-add-cart') || e.target.closest('.ajax-add-cart')) {
        e.preventDefault();
        const btn = e.target.classList.contains('ajax-add-cart') ? e.target : e.target.closest('.ajax-add-cart');
        const url = btn.getAttribute('href');

        if (!url) return;

        // Visual feedback - Loading state
        const originalContent = btn.innerHTML;
        const originalWidth = btn.offsetWidth; // Capture width to prevent layout shift
        btn.style.width = `${originalWidth}px`;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.style.pointerEvents = 'none';

        try {
          const res = await fetch(url, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRF-TOKEN': '{{ csrf_token() }}'
            }
          });
          const data = await res.json();

          if (data.success) {
            // Update Cart Count
            const countEl = document.getElementById('cart-count');
            if (countEl) countEl.textContent = data.cart_count || (parseInt(countEl.textContent || 0) + 1);

            showNotification(data.message || 'Added to cart!', 'success');

            // Success feedback on button
            btn.classList.add('btn-success');
            // btn.classList.remove('btn-primary', 'btn-outline-primary'); 
            btn.innerHTML = '<i class="bi bi-check2"></i>';

            setTimeout(() => {
              // Revert button state
              btn.innerHTML = originalContent;
              btn.classList.remove('btn-success');
              // btn.classList.add('btn-primary'); // Basic reversion, might need specific logic if we removed specific classes
              btn.style.width = '';
              btn.style.pointerEvents = 'auto';
            }, 700);

          } else {
            showNotification(data.message || 'Could not add item.', 'warning');
            btn.innerHTML = originalContent;
            btn.style.width = '';
            btn.style.pointerEvents = 'auto';
          }
        } catch (err) {
          console.error(err);
          showNotification('Something went wrong. Please try again.', 'danger');
          btn.innerHTML = originalContent;
          btn.style.width = '';
          btn.style.pointerEvents = 'auto';
        }
      }
    });
  </script>

  <script src="{{ url_for('static', filename='js/main.js') }}"></script>

  {% block scripts %}{% endblock %}
</body>

</html>